---
title: "DESeq2_spruce"
output: html_document
date: "2025-11-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/projects/eco_genomics_2025/final_project/mydata")
```

Import the libraries that we're likely to need in this session
```{r message=FALSE, warning=FALSE}
library(DESeq2)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(ggpubr)
library(vsn)  
library("pheatmap")
library("vsn")
library(eulerr)
```

Import data:
```{r} 
# Import the counts table
countsTable <- read.csv("counts_matrix.csv", header=TRUE, row.names=1)

countsTableRound <- round(countsTable)
head(countsTableRound)

samples <- colnames(countsTableRound)
removeBLANK <- !grepl("BLANK", samples) # remove "BLANK_ACATTA from table"
countsTableRound <- countsTableRound[, removeBLANK]
samples <- colnames(countsTableRound)

# Import the metadata file
metadata_spruce <- read.csv("metadata_spruce.csv", header = TRUE, row.names=1)
```

Explore data distributions:
```{r}
colSums(countsTableRound)
mean(colSums(countsTableRound))
```

Visualizing variation across samples and genes:
```{r}
# variation across samples:
barplot(colSums(countsTableRound), names.arg=colnames(countsTableRound),cex.names=0.5, las=3,ylim=c(0,2500000))
abline(h=mean(colSums(countsTableRound)), col="blue", lwd=2)

# average number of counts per gene:
mean(rowSums(countsTableRound))
median(rowSums(countsTableRound))

# variation across genes:
apply(countsTableRound,2,mean) # 2 in apply, action across columns
apply(countsTableRound,1,mean) # 1 in apply, action across rows
hist(apply(countsTableRound,1,mean),xlim=c(0,6), ylim=c(0,60000),breaks=1000000)
```

Now we are going to start working with DESeq2!
```{r}
# subsetting to only include data from day 10
day10_samps = grep("_10_",colnames(countsTableRound))

# creating DESeq objects and defining the experimental design here with the tilda

dds <- DESeqDataSetFromMatrix(countData = countsTableRound[,day10_samps],
                              colData=metadata_spruce[which(metadata_spruce$day_harvest == 10),],
                              design= ~ source_climate + treatment)

dim(dds)

# Filter out genes with too few reads by removing all genes with counts < 15
dds <- dds[rowSums(counts(dds) >= 15) >= 18,]
nrow(dds) 

# Run the DESeq model to test for differential gene expression
dds <- DESeq(dds)

# List the results you've generated
resultsNames(dds)

# Copy the results names 
```

```{r}
# Transformation to remove the dependence of the variance on the mean, particularly the high variance of the logarithm of count data when the mean is low."

# this gives log2(n + 1)
ntd <- normTransform(dds)
meanSdPlot(assay(ntd))

# Variance stabilizing transformation
vsd <- vst(dds, blind=FALSE)
meanSdPlot(assay(vsd))
```

Make a heatmap of the distance/dissimilarity of the samples:
```{r}
sampleDists <- dist(t(assay(vsd)))

library("RColorBrewer")
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$treament, vsd$day_harvest, sep="-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors)

# Note any outliers
```

Making a cluster tree to look for outlier samples:
```{r}
sampleTree <- hclust(dist(sampleDists), method = "average")

# plot
plot(sampleTree, main="Sample clustering to detect outliers", sub="", xlab="",cex.lab=1.5, cex.axis=1.5, cex.main=2)

# is there a tree that we see on its own? We see two clusters but nothing particularly on its own
```

PCA to visualize global gene expression patterns:
```{r}
# first transform the data for plotting using variance stabilization
vsd <- vst(dds, blind=FALSE)

pcaData <- plotPCA(vsd, intgroup=c("treatment","source_climate"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData,"percentVar"))

ggplot(pcaData, aes(PC1, PC2, color=treatment, shape=source_climate)) +
  geom_point(size=3) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  coord_fixed()
```

```{r}
ggplot(pcaData, aes(PC1, PC2)) +
  geom_point(size=5, stroke = 1, aes(fill = source_climate, shape = treatment, alpha = day_harvest)) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) +
  scale_fill_manual(values=c('#6699CC',"#CC3333"), labels = c("Control", "Treatment"))+
  theme_linedraw() +
  theme(legend.position = "none") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 3))+
  theme(text = element_text(size = 20)) +
  theme(legend.title = element_blank()) +
  theme_linedraw()
```

There appears to be some clustering...!!!! But let's try specific contrasts just in case.
```{r}

metadata_spruce$day_harvest <- as.character(metadata_spruce$day_harvest)
dds$treatment <- relevel(dds$treatment, ref = "Control")
dds$source_climate <- relevel(dds$source_climate, ref = "HotDry")

dds$group <- factor(paste0(dds$source_climate, dds$treatment))
design(dds) <- ~ group
dds <- DESeq(dds)
resultsNames(dds)
```

Comparing source_climate with the three different treatments:
```{r}
coolwet_DHvCont <- results(dds, contrast=c("group","CoolWetDrought; Heat","CoolWetControl"), alpha = 0.05)
summary(coolwet_DHvCont)

coolwet_HvCont <- results(dds, contrast=c("group","CoolWetHeat","CoolWetControl"), alpha = 0.05)
summary(coolwet_HvCont)

hotdry_Contvcoolwet_Cont <- results(dds, contrast=c("group","HotDryControl","CoolWetControl"), alpha = 0.05)
summary(hotdry_Contvcoolwet_Cont)

hotdry_DHvcoolwet_Cont <- results(dds, contrast=c("group","HotDryDrought; Heat","CoolWetControl"), alpha = 0.05)
summary(hotdry_DHvcoolwet_Cont)

hotdry_Hvcoolwet_Cont <- results(dds, contrast=c("group","HotDryDrought; Heat","CoolWetControl"), alpha = 0.05)
summary(hotdry_Hvcoolwet_Cont)

```

Now we are making an MA plot:

- Question: What is the relationship between LFC and magnitude of expression?

```{r}
plotMA(coolwet_DHvCont, ylim=c(-5,5))
plotMA(coolwet_HvCont, ylim=c(-5,5))
plotMA(hotdry_Contvcoolwet_Cont, ylim=c(-5,5))
plotMA(hotdry_DHvcoolwet_Cont, ylim=c(-5,5))
plotMA(hotdry_Hvcoolwet_Cont, ylim=c(-5,5))

```

Making volcano plots:

- Question: What is the relationship between LFC and significance of DGE?

- First make it into a dataframe and remove NAs, add column to dataframe called "significance" and include adjust parameters showing "up" and "down" regulated genes. Then using ggplot with log fold change on the X axis and adjusted p-value on Y axis. Using the new column of significance to show up and downregulated genes, then giving lines to show log fold change and p-value.

```{r}

### coolwet_DHvCont volcano plot:

res_df <- as.data.frame(coolwet_DHvCont) # Make a dataframe
res_df <- res_df[!is.na(res_df$padj), ] # Remove NAs
res_df$significance <- "Not Sig" # Add significance column for color mapping
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange > 0] <- "Up"
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange < 0] <- "Down"

volcano_coolwet_DHvCont <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = significance)) +
  geom_point(alpha = 0.7, size = 2) +
  scale_color_manual(values = c("Up" = "blue", "Down" = "red", "Not Sig" = "grey")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  labs(
    title = "Volcano Plot: Coolwet - Drought; Heat vs Control",
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~Adjusted~p~value)
  ) +
  theme_bw(base_size = 16) +
  theme(legend.title = element_blank())

volcano_coolwet_DHvCont


### coolwet_HvCont volcano plot:

res_df <- as.data.frame(coolwet_HvCont) # Make a dataframe
res_df <- res_df[!is.na(res_df$padj), ] # Remove NAs
res_df$significance <- "Not Sig" # Add significance column for color mapping
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange > 0] <- "Up"
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange < 0] <- "Down"

volcano_coolwet_HvCont <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = significance)) +
  geom_point(alpha = 0.7, size = 2) +
  scale_color_manual(values = c("Up" = "blue", "Down" = "red", "Not Sig" = "grey")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  labs(
    title = "Volcano Plot: Coolwet - Heat vs Control",
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~Adjusted~p~value)
  ) +
  theme_bw(base_size = 16) +
  theme(legend.title = element_blank())

volcano_coolwet_HvCont

### hotdry_Contvcoolwet_Cont volcano plot:

res_df <- as.data.frame(hotdry_Contvcoolwet_Cont) # Make a dataframe
res_df <- res_df[!is.na(res_df$padj), ] # Remove NAs
res_df$significance <- "Not Sig" # Add significance column for color mapping
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange > 0] <- "Up"
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange < 0] <- "Down"

volcano_hotdry_Contvcoolwet_Cont <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = significance)) +
  geom_point(alpha = 0.7, size = 2) +
  scale_color_manual(values = c("Up" = "blue", "Down" = "red", "Not Sig" = "grey")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  labs(
    title = "Volcano Plot: HotDry - Control vs CoolWet - Control",
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~Adjusted~p~value)
  ) +
  theme_bw(base_size = 16) +
  theme(legend.title = element_blank())

volcano_hotdry_Contvcoolwet_Cont

### hotdry_DHvcoolwet_Cont

res_df <- as.data.frame(hotdry_DHvcoolwet_Cont) # Make a dataframe
res_df <- res_df[!is.na(res_df$padj), ] # Remove NAs
res_df$significance <- "Not Sig" # Add significance column for color mapping
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange > 0] <- "Up"
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange < 0] <- "Down"

volcano_hotdry_DHvcoolwet_Cont <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = significance)) +
  geom_point(alpha = 0.7, size = 2) +
  scale_color_manual(values = c("Up" = "blue", "Down" = "red", "Not Sig" = "grey")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  labs(
    title = "Volcano Plot: HotDry - Drought; Heat vs CoolWet - Control",
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~Adjusted~p~value)
  ) +
  theme_bw(base_size = 16) +
  theme(legend.title = element_blank())

volcano_hotdry_DHvcoolwet_Cont

### hotdry_Hvcoolwet_Cont volcano plot:

res_df <- as.data.frame(hotdry_Hvcoolwet_Cont) # Make a dataframe
res_df <- res_df[!is.na(res_df$padj), ] # Remove NAs
res_df$significance <- "Not Sig" # Add significance column for color mapping
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange > 0] <- "Up"
res_df$significance[res_df$padj < 0.05 & res_df$log2FoldChange < 0] <- "Down"

volcano_hotdry_Hvcoolwet_Cont <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = significance)) +
  geom_point(alpha = 0.7, size = 2) +
  scale_color_manual(values = c("Up" = "blue", "Down" = "red", "Not Sig" = "grey")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  labs(
    title = "Volcano Plot: HotDry - Heat vs CoolWet - Control",
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~Adjusted~p~value)
  ) +
  theme_bw(base_size = 16) +
  theme(legend.title = element_blank())

volcano_hotdry_Hvcoolwet_Cont

```

Heatmap #1 - top 10 genes sorted by p-value:

- Question: For DEGs, what does gene expression variation look like across individual samples among treatment groups?

- In this heatmap, we are only pulling the top 100 genes, regardless of whether they are up or downregulated.
- Normalizing it by getting rid of top row of genes, making it into a dataframe, plotting it using a heatmap and don't want to cluster by columns.
```{r}
### top 10 genes for coolwet_DHvCont, anything more than 10 looked really squished on the heat map.
topgenes <- head(rownames(coolwet_DHvCont),10)
mat <- assay(vsd)[topgenes,]
mat <- mat - rowMeans(mat)
df <- as.data.frame(colData(dds)[,c("source_climate","treatment")])
pheatmap(mat, annotation_col=df)
pheatmap(mat, annotation_col=df, cluster_cols = F)

```

Make a heatmap of treatment significant genes and how they change across source_climate:

- Question: How does gene expression change across treatments compared to source climate?

- Start by identifying significant genes, then make a dataframe with log fold change for all of the significant genes from treatment types (we'll call this log fold change matrix), then remove rows with any same values, and use a heatmap to plot the dataframe and scale it by rows and then by color. Cluster by rows and colors by equal distance.

*YOU STOPPED HERE AND ARE CONFUSED*

```{r}
sig_genes <- rownames(resG1_CvT[which(resG1_CvT$padj < 0.05 & !is.na(resG1_CvT$padj)), ])

# Combine into a data frame
lfc_mat <- data.frame(
  Gen1 = resG1_CvT[sig_genes_G1, "log2FoldChange"],
  Gen2 = resG2_CvT[sig_genes_G1, "log2FoldChange"],
  Gen3 = resG3_CvT[sig_genes_G1, "log2FoldChange"],
  Gen4 = resG4_CvT[sig_genes_G1, "log2FoldChange"]
)

# Remove any rows with missing values (some genes may not be in all result tables)
lfc_mat <- na.omit(lfc_mat)

pheatmap(lfc_mat,
         scale = "row",             # scales each gene’s LFCs across generations
         color = colorRampPalette(c("blue", "white", "red"))(50),
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         clustering_method = "complete",
         show_rownames = FALSE,
         main = "LFC (Treatment vs Control) of Sig Genes in Gen 1")
```

Making a heatmap for Generation 2:

- What is happening in generation 2?

  - Biologically-relevant thoughts:
  - In G2, there are more differentially expressed genes compared to G1. Did they adjust their physiology through development?
  - In the first generation, parents are already making gametes and there is direct exposure from G1 to G2.
  - There could also be epigenetic variation looking at DNA methylation.
  - In G2, they are in the same environment, but may have inherited different epigenetic patterns.

- Experiment-relevant thoughts:
  - Only two samples in Generation 2.
```{r}
sig_genes_G2 <- rownames(resG2_CvT[which(resG2_CvT$padj < 0.05 & !is.na(resG2_CvT$padj)), ])

# Combine into a data frame
lfc_mat_G2 <- data.frame(
  Gen1 = resG1_CvT[sig_genes_G2, "log2FoldChange"],
  Gen2 = resG2_CvT[sig_genes_G2, "log2FoldChange"],
  Gen3 = resG3_CvT[sig_genes_G2, "log2FoldChange"],
  Gen4 = resG4_CvT[sig_genes_G2, "log2FoldChange"]
)

# Remove any rows with missing values (some genes may not be in all result tables)
lfc_mat_G2 <- na.omit(lfc_mat_G2)

pheatmap(lfc_mat_G2,
         scale = "row",             # scales each gene’s LFCs across generations
         color = colorRampPalette(c("blue", "white", "red"))(50),
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         clustering_method = "complete",
         show_rownames = FALSE,
         main = "LFC (Treatment vs Control) of Sig Genes in Gen 2")
```

Here we can make a Venn or Euler plot:

- Question: How much overlap is there between genes differentially expressed between treatments across generations?

```{r}
# Total
length(degs_G1_CvTM)  # 573 genes differentially expressed
length(degs_G2_CvTM)  # 4568 genes differentially expressed
length(degs_G3_CvTM)  # 1234 genes differentially expressed
length(degs_G4_CvTM)  # 40 genes differentially expressed

# Intersections
length(intersect(degs_G1_CvTM,degs_G2_CvTM))  # 227
length(intersect(degs_G1_CvTM,degs_G3_CvTM))  # 71
#length(intersect(degs_G1_CvTM,degs_G4_CvTM))

length(intersect(degs_G2_CvTM,degs_G3_CvTM))  # 294 
#length(intersect(degs_G2_CvTM,degs_G4_CvTM))  
#length(intersect(degs_G3_CvTM,degs_G4_CvTM)) 

# To calc number shared in all three contrasts
int12 <- intersect(degs_G1_CvTM,degs_G2_CvTM)
length(intersect(degs_G3_CvTM,int12)) # 13 - intersect of all three contrasts

# Number unique
573 - 227 - 71 + 13 #  G1, 288 genes are totally unique to generation 1
4568 - 227 - 294 + 13 #  G2, 4060 genes are totally unique to generation 2
1234 - 71 - 294 + 13 #  G3, 882 genes are totally unique to generation 3

227 - 13 # G1&G2, 214 genes 
71 - 13 # G1&G3, 58 genes
294 - 13 # G2&G3, 281 genes

# Note that the names are important and have to be specific to line up the diagram
fit1 <- euler(c("G1" = 288, "G2" = 4060, "G3" = 882 , "G1&G2" = 214, "G1&G3" = 58, "G2&G3" = 281, "G1&G2&G3" = 13))


plot(fit1,  lty = 1:3, quantities = TRUE)
# lty changes the lines

plot(fit1, quantities = TRUE, fill = "transparent",
     lty = 1:3,
     labels = list(font = 4))

#cross check
 #  total G1
 #  total G2
 #  total G3
```