---
title: "DESeq2ToTopGo Final Project"
author: "G. Rei Jia"
date: "2025-11-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/projects/eco_genomics_2025/final_project/mydata")
```

```{r}
library(topGO)
library(GO.db)

# Convert to data frame
coolwet_DHvCont_df <- as.data.frame(coolwet_DHvCont)

# Add geneID column from rownames
coolwet_DHvCont_df$geneID <- rownames(coolwet_DHvCont)
coolwet_DHvCont_df <- coolwet_DHvCont_df[, c("geneID", setdiff(names(coolwet_DHvCont_df), "geneID"))]

# Read GO terms file () provided in 
spruce_go <- read.delim("Pmariana_GOannot.tsv", header = TRUE) %>%
  slice(-c(1,2)) %>%  # remove header rows if present
  na.omit()  # remove missing GO annotations

# Identify DEGs that have GO annotations
coolwet_DHvCont_go <- coolwet_DHvCont_df[coolwet_DHvCont_df$geneID %in% spruce_go$geneID, ]

# Keep only significant DEGs 
coolwet_DHvCont_GO_sig <- subset(spruce_go, padj < 0.05 & abs(log2FoldChange) > 1)


# Merge with GO annotations
coolwet_DHvCont_stat <- merge(coolwet_DHvCont_GO_sig, spruce_go, by = "geneID")

# Create gene2GO list which is used in the topgo function 
treatment1GO <- spruce_go %>%
  filter(!is.na(GO) & GO != "") %>%
  group_by(geneID) %>%
  summarise(GO = list(unique(GO)), .groups = "drop") %>%
  with(setNames(GO, geneID))

# Split semicolon-separated GO terms
treatment1GO <- lapply(treatment1GO, function(x) unlist(strsplit(x, ";")))

# Create geneList for TopGO: 1 = DEG, 0 = not DEG
all_genes <- names(treatment1GO)
geneList <- setNames(as.integer(all_genes %in% coolwet_DHvCont_stat$geneID), all_genes)

#Build TopGO pipeline 
coolwet_DHvCont_stat_GOdata <- new("coolwet_DHvCont_stat_GOdata",
              description = "CoolWet: Drought; Heat vs. Control DEGs GO enrichment",
              ontology = "BP",
              allGenes = geneList,
              geneSel = function(x) x == 1,
              nodeSize = 5,
              annot = annFUN.treatment1GO,
              treatment1GO = treatment1GO)

#test for enrichment 
result <- runTest(coolwet_DHvCont_stat_GOdata, algorithm = "parentChild", statistic = "fisher")

# Convert results to table
res_table <- GenTable(coolwet_DHvCont_stat_GOdata, classicFisher = result,
                      topNodes = length(usedGO(coolwet_DHvCont_stat_GOdata))) %>%
  mutate(classicFisher = as.numeric(classicFisher),
         Annotated = as.numeric(Annotated),
         Significant = as.numeric(Significant))

#plot!

# Keep GO terms with enough but not too many genes
filtered_GO_results <- res_table %>%
  filter(Annotated >= 5 & Annotated < 500) %>%  # adjust as needed
  group_by(Term) %>%
  slice_min(classicFisher, n = 1) %>%  # keep only the most significant per Term
  ungroup() %>%
  arrange(classicFisher)


coolwet_DHvCont_TopGO_plot <- function(df, title) {
  df %>%
    slice_head(n = 30) %>%
    ggplot(aes(x = -log10(classicFisher),
               y = reorder(Term, -log10(classicFisher)),
               size = Significant,
               color = -log10(classicFisher))) +
    geom_point(alpha = 0.8) +
    scale_color_gradientn(
      colors = c("pink", "orchid", "purple", "purple4"),
      name = "-log10(p-value)"
    ) +
    scale_size_continuous(name = "# Significant Genes") +
    xlab("-log10-classicFisher") +
    ylab("Biological Function") +
    ggtitle(title) +
    theme_minimal() +
    theme(plot.margin = margin(10, 100, 10, 10),
          axis.text.y = element_text(size = 10, hjust = 1)) +
    coord_cartesian(clip = "off")
}

# Generate plot
coolwet_DHvCont_topGO_plot <- TopGO_plot(filtered_GO_results, "GO Enrichment for DEGs at Day 10: CoolWet - Drought; Heat vs. Control")
coolwet_DHvCont_topGO_plot
```